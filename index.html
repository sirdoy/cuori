<?php
/*
 * Script per la gestione dei documenti polizze
 * Proprietario: Federico Manfredi
 * Data di creazione: 10-12-2024
 * Descrizione: Questo script gestisce il movimento e la rinominazione dei file associati alle polizze, oltre ad aggiornare o eliminare i record corrispondenti nel database.
 * Versione: 1.0.0
 * Ultima modifica: 10-12-2024
 * Email per contatti o supporto: federico.manfredi@netgloo.com
 */
session_start();

$startTimestamp = microtime(true);

const DEBUG = true; // Attiva i log di debug
const PATH_TO_ROOT = __DIR__ . '/../../'; // Percorso base del progetto

// Variabili per i percorsi
$sourcePath = PATH_TO_ROOT . "docPolizze"; // Percorso della cartella di partenza
$destinationPath = PATH_TO_ROOT . "docPolizze"; // Percorso della cartella di destinazione

// Configurazione comportamento finale
// Opzioni possibili: "update", "delete", "none"
const FINAL_ACTION = "update"; // PuÃ² essere "update", "delete", o "none"

// Indirizzo email per le notifiche di errore
$notificationEmail = "federico.manfredi@netgloo.com";

require("../common.php");
require "../utility/helpers.php";

$log = logger();

// Funzioni per i colori
function colorize($text, $colorCode)
{
    return "\033[" . $colorCode . "m" . $text . "\033[0m";
}

function logInfo($message)
{
    echo colorize("[INFO] $message\n", "32"); // Verde
}

function logError($message)
{
    echo colorize("[ERROR] $message\n", "31"); // Rosso
}

function logProgress($message)
{
    echo colorize("\r[PROGRESS] $message", "33"); // Giallo
}

logInfo("=== Script Gestione Documenti Polizze ===");

$log->info("Script avviato.");
logInfo("Script avviato.");

// Connetti al database
$connection = dbConnect();
if (!$connection) {
    $error = "Errore nella connessione al database.";
    $log->error($error);
    logError($error);
    mail($notificationEmail, "Errore script PHP", $error);
    exit;
}
$log->info("Connessione al database avvenuta con successo.");
logInfo("Connessione al database riuscita.");

// Query per recuperare i dati necessari
$query = "
    SELECT 
        dp.file AS file_name,
        p.numero AS polizza_numero,
        p.ramo AS ramo,
        p.id AS id_polizza,
        c.piva_cf AS codice_fiscale,
        dp.id AS documento_id
    FROM 
        documenti_polizze dp
    INNER JOIN 
        polizze p ON dp.polizza = p.id
    INNER JOIN 
        clienti c ON p.cliente = c.id
";

$log->debug("Esecuzione della query: $query");
logInfo("Recupero dei dati...");
$result = mysqli_query($connection, $query);

if (!$result) {
    $error = "Errore durante l'esecuzione della query: " . mysqli_error($connection);
    $log->error($error);
    logError($error);
    mail($notificationEmail, "Errore script PHP", $error);
    exit;
}

$log->info("Query eseguita con successo.");
logInfo("Dati recuperati con successo.");

// Processa i risultati
$rowCount = 0;
$totalRows = mysqli_num_rows($result);
$updateQueries = [];
$deleteQueries = [];

logInfo("Inizio elaborazione dei file...");

while ($row = mysqli_fetch_assoc($result)) {
    $rowCount++;
    $fileName = $row['file_name'];
    $polizzaNumero = $row['polizza_numero'];
    $ramo = $row['ramo'];
    $idPolizza = $row['id_polizza'];
    $codiceFiscale = $row['codice_fiscale'];
    $documentoId = $row['documento_id'];

    // Percorso completo del file di origine
    $sourceFile = $sourcePath . '/' . $fileName;

    if (!file_exists($sourceFile)) {
        // Se il file non esiste, cancella la riga nel DB
        $error = "File non trovato: $sourceFile. Eliminando la riga corrispondente dal DB.";
        $log->error($error);
        logError("File non trovato: $fileName");

        // Query per cancellare il documento dal DB
        if (FINAL_ACTION !== "none") {
            $deleteQueries[] = "
                DELETE FROM documenti_polizze
                WHERE id = " . intval($documentoId) . "
            ";
        }
        mail($notificationEmail, "Errore script PHP", $error);
        continue;
    }

    // Determina la cartella di destinazione
    $destinationFolder = $destinationPath . '/' . $codiceFiscale;

    // Crea la cartella se non esiste
    if (!is_dir($destinationFolder)) {
        if (!mkdir($destinationFolder, 0755, true)) {
            $error = "Errore nella creazione della cartella: $destinationFolder";
            $log->error($error);
            logError("Creazione cartella fallita: $destinationFolder");
            mail($notificationEmail, "Errore script PHP", $error);
            continue;
        }
        $log->info("Cartella creata: $destinationFolder");
        logInfo("Cartella creata: $destinationFolder");
    }

    // Rinominazione del file
    $newFileName = "{$polizzaNumero}-{$ramo}-{$idPolizza}";
    $destinationFile = $destinationFolder . '/' . $newFileName;

    // Sposta il file
    if (!rename($sourceFile, $destinationFile)) {
        $error = "Errore nello spostamento del file $sourceFile a $destinationFile";
        $log->error($error);
        logError("Errore nello spostamento del file: $fileName");
        mail($notificationEmail, "Errore script PHP", $error);
        continue;
    }

    // Prepara le query in base alla configurazione
    $newRelativePath = $codiceFiscale . '/' . $newFileName;
    if (FINAL_ACTION === "update") {
        $updateQueries[] = "
            UPDATE documenti_polizze
            SET file = '" . mysqli_real_escape_string($connection, $newRelativePath) . "'
            WHERE file = '" . mysqli_real_escape_string($connection, $fileName) . "'
        ";
    } elseif (FINAL_ACTION === "delete") {
        $deleteQueries[] = "
            DELETE FROM documenti_polizze
            WHERE file = '" . mysqli_real_escape_string($connection, $fileName) . "'
        ";
    }

    // Mostra progresso
    $progress = number_format(($rowCount / $totalRows) * 100, 2);
    logProgress("Elaborazione: $rowCount/$totalRows ($progress%) completata.");
}
echo "\n";
logInfo("Elaborazione completata per $rowCount righe.");

// Esegui le operazioni finali
if (FINAL_ACTION === "update" && !empty($updateQueries)) {
    logInfo("Aggiornamento dei path a database...");
    foreach ($updateQueries as $query) {
        if (!mysqli_query($connection, $query)) {
            $error = "Errore nell'aggiornamento del database: " . mysqli_error($connection);
            $log->error($error);
            logError("Errore aggiornamento database.");
            mail($notificationEmail, "Errore script PHP", $error);
        }
    }
    logInfo("Aggiornamento completato.");
} elseif (FINAL_ACTION === "delete" && !empty($deleteQueries)) {
    logInfo("Eliminazione delle righe a database...");
    foreach ($deleteQueries as $query) {
        if (!mysqli_query($connection, $query)) {
            $error = "Errore nell'eliminazione dal database: " . mysqli_error($connection);
            $log->error($error);
            logError("Errore eliminazione database.");
            mail($notificationEmail, "Errore script PHP", $error);
        }
    }
    logInfo("Eliminazione completata.");
} else {
    logInfo("Nessuna operazione finale configurata.");
}

// Disconnetti dal database
dbDisconnect($connection);

$executionTime = microtime(true) - $startTimestamp;
logInfo("Script completato in {$executionTime} secondi.");
